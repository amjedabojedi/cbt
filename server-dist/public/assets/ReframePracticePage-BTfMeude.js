import{c as pe,$ as je,m as ve,n as De,u as de,r as w,y as $e,R as Ne,j as e,A as O,q as V,o as Y,p as K,B as L,i as ae,C as P,e as q,f as M,a as S,l as Le,g as le}from"./index-BJDVYPr2.js";import{u as X}from"./useQuery-CVl6tFXz.js";import{u as Ee}from"./useMutation-4_CoT2bx.js";import{P as Re}from"./progress-XD4z056s.js";import{C as me}from"./circle-check-CkKaz49B.js";import{a as qe,B as ge}from"./Header-HmO9KIvP.js";import{C as ye}from"./target-7abParum.js";import{Z as Me}from"./zap-lHWNfvuW.js";import{C as Qe}from"./clock-Od4KD6Fc.js";import{B as Fe}from"./brain-circuit-ClF974iG.js";import{T as Be}from"./thumbs-up-DxuJ4IXa.js";import{f as He}from"./format-CrnBQ42y.js";import{A as Oe}from"./AppLayout-B4pR-pjA.js";import{A as Ye}from"./arrow-left-CJqe-HNu.js";import"./utils-km2FGkQ4.js";import"./index-ZMpGrT0S.js";import"./index-epKMAjhH.js";import"./check-CPyQFfyd.js";import"./en-US-9SRVm7yB.js";/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ke=pe("BadgeCheck",[["path",{d:"M3.85 8.62a4 4 0 0 1 4.78-4.77 4 4 0 0 1 6.74 0 4 4 0 0 1 4.78 4.78 4 4 0 0 1 0 6.74 4 4 0 0 1-4.77 4.78 4 4 0 0 1-6.75 0 4 4 0 0 1-4.78-4.77 4 4 0 0 1 0-6.76Z",key:"3c2336"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const We=pe("Trophy",[["path",{d:"M6 9H4.5a2.5 2.5 0 0 1 0-5H6",key:"17hqa7"}],["path",{d:"M18 9h1.5a2.5 2.5 0 0 0 0-5H18",key:"lmptdp"}],["path",{d:"M4 22h16",key:"57wxv0"}],["path",{d:"M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22",key:"1nw9bq"}],["path",{d:"M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22",key:"1np0yb"}],["path",{d:"M18 2H6v7a6 6 0 0 0 12 0V2Z",key:"u46fv3"}]]);function Ge(t){return t?t==="emotional-reasoning"?"Emotional Reasoning":t==="mind-reading"?"Mind Reading":t==="fortune-telling"?"Fortune Telling":t==="all-or-nothing"?"All or Nothing":t==="unknown"?"Cognitive Distortion":t.replace(/[-_]/g," ").split(" ").map(c=>c.charAt(0).toUpperCase()+c.slice(1)).join(" "):"Unknown"}function Ve(t){return t?t==="unknown"?"Emotion":t.replace(/[-_]/g," ").split(" ").map(c=>c.charAt(0).toUpperCase()+c.slice(1)).join(" "):"Unknown"}const Ze=({scenario:t,currentIndex:c,totalScenarios:h,onSelectOption:u,selectedOptionIndex:r,showFeedback:g,onNext:d})=>e.jsxs(P,{className:"w-full mb-6",children:[e.jsxs(q,{children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsx("div",{className:"flex items-center",children:e.jsxs("span",{className:"text-sm font-medium text-muted-foreground",children:["Scenario ",c+1," of ",h]})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"bg-muted px-2 py-1 rounded text-xs font-medium",children:Ge(t.cognitiveDistortion)}),e.jsx("span",{className:"bg-muted px-2 py-1 rounded text-xs font-medium",children:Ve(t.emotionCategory)})]})]}),e.jsx(M,{className:"text-xl",children:t.scenario})]}),e.jsxs(S,{className:"space-y-4",children:[e.jsx("p",{className:"font-medium mb-4",children:"How would you reframe this thought?"}),t.options.map((i,n)=>e.jsx("div",{className:`p-4 border rounded-md cursor-pointer transition-all ${r===n?i.isCorrect?"border-green-500 bg-green-50 dark:bg-green-950/30":g?"border-red-500 bg-red-50 dark:bg-red-950/30":"border-primary bg-primary/5":"hover:border-primary/50"} ${g&&i.isCorrect?"border-green-500 bg-green-50 dark:bg-green-950/30":""}`,onClick:()=>!g&&u(n),children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"mt-0.5",children:g?i.isCorrect?e.jsx(me,{className:"h-5 w-5 text-green-500"}):r===n?e.jsx(V,{className:"h-5 w-5 text-red-500"}):null:e.jsx("div",{className:`h-5 w-5 rounded-full border ${r===n?"bg-primary border-primary":"border-muted-foreground"}`})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:i.text}),g&&(r===n||i.isCorrect)&&e.jsx("div",{className:"mt-2 text-sm text-muted-foreground",children:e.jsx("p",{children:i.explanation})})]})]})},n))]}),e.jsx(Le,{className:"flex justify-between",children:e.jsx("div",{className:"w-full",children:g&&e.jsxs(L,{className:"mt-4 w-full",onClick:d,children:[c<h-1?"Next Scenario":"See Results",e.jsx(qe,{className:"ml-2 h-4 w-4"})]})})})]}),_e=({userChoices:t,scenarios:c,totalScore:h,userId:u,gameUpdates:r,onStartNew:g,assignmentId:d,thoughtRecordId:i,isQuickPractice:n})=>{var j;const a=t.filter(k=>k.isCorrect).length;return e.jsxs("div",{className:"space-y-6",children:[e.jsxs(P,{children:[e.jsx(q,{children:e.jsxs(M,{className:"flex items-center",children:[e.jsx(ye,{className:"mr-2 h-5 w-5"}),"Practice Results"]})}),e.jsxs(S,{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-3 gap-4 mb-4",children:[e.jsxs("div",{className:"text-center p-4 bg-muted/20 rounded-md",children:[e.jsx("p",{className:"text-muted-foreground text-sm",children:"Score"}),e.jsx("p",{className:"text-2xl font-bold",children:h})]}),e.jsxs("div",{className:"text-center p-4 bg-muted/20 rounded-md",children:[e.jsx("p",{className:"text-muted-foreground text-sm",children:"Correct"}),e.jsxs("p",{className:"text-2xl font-bold",children:[a," / ",c.length]})]}),e.jsxs("div",{className:"text-center p-4 bg-muted/20 rounded-md",children:[e.jsx("p",{className:"text-muted-foreground text-sm",children:"Accuracy"}),e.jsxs("p",{className:"text-2xl font-bold",children:[c.length>0?Math.round(a/c.length*100):0,"%"]})]})]}),((j=r==null?void 0:r.newAchievements)==null?void 0:j.length)>0&&e.jsxs(O,{className:"bg-yellow-50 dark:bg-yellow-950/30 border-yellow-200 dark:border-yellow-800",children:[e.jsx(We,{className:"h-4 w-4 text-yellow-500"}),e.jsx(Y,{children:"New Achievements!"}),e.jsxs(K,{children:["You earned ",r.newAchievements.length," new ",r.newAchievements.length===1?"achievement":"achievements",":",e.jsx("ul",{className:"mt-2 list-disc pl-5",children:r.newAchievements.map(k=>e.jsx("li",{children:k.replace(/_/g," ")},k))})]})]}),(r==null?void 0:r.newLevel)>(r==null?void 0:r.prevLevel)&&e.jsxs(O,{className:"bg-blue-50 dark:bg-blue-950/30 border-blue-200 dark:border-blue-800",children:[e.jsx(Me,{className:"h-4 w-4 text-blue-500"}),e.jsx(Y,{children:"Level Up!"}),e.jsxs(K,{children:["You've reached level ",r.newLevel,"! Keep practicing to unlock more achievements."]})]}),e.jsxs("div",{className:"flex justify-center flex-col items-center",children:[e.jsxs(O,{className:"bg-green-50 dark:bg-green-950/30 border-green-200 dark:border-green-800 mb-4",children:[e.jsx(me,{className:"h-4 w-4 text-green-500"}),e.jsx(Y,{children:"Results Saved"}),e.jsx(K,{children:"Your practice results have been saved successfully. Your progress is being tracked!"})]}),e.jsxs("div",{className:"flex gap-4",children:[e.jsx(L,{onClick:()=>window.location.href=`/users/${u}/thoughts`,variant:"outline",className:"mt-2 px-6 py-2 text-base",children:"Return to Thought Records"}),e.jsx(L,{onClick:()=>window.location.href=`/users/${u}/reframe-coach?tab=history`,className:"mt-2 px-6 py-2 text-base",children:"View Practice History"})]})]})]})]}),r&&r.newAchievements&&r.newAchievements.length>0&&e.jsxs(P,{className:"mb-4",children:[e.jsx(q,{children:e.jsx(M,{children:"New Achievements"})}),e.jsx(S,{children:e.jsx("div",{className:"flex flex-col gap-2",children:r.newAchievements.map((k,E)=>e.jsxs(O,{className:"bg-green-50 border-green-200",children:[e.jsx(Ke,{className:"h-5 w-5 text-green-600"}),e.jsx(Y,{className:"text-green-800",children:"Achievement Unlocked!"}),e.jsxs(K,{className:"text-green-700",children:[k.name," - ",k.description]})]},E))})})]})]})},xe=({userId:t,thoughtRecordId:c,assignmentId:h,practiceScenarios:u,isQuickPractice:r=!1})=>{var he;const g=je(),[d,i]=ve(),{toast:n}=De(),{user:a,loading:j}=de(),[k,E]=w.useState(!1);w.useEffect(()=>{j||(E(!0),console.log("Authentication status:",{isAuthenticated:!!a,userId:a==null?void 0:a.id,propUserId:t,authLoading:j}),a||(console.error("User not authenticated in ReframePractice component"),n({title:"Authentication Required",description:"Please log in to access this feature",variant:"destructive"})))},[a,j,t,n]);const m=$e(),s=new URLSearchParams(d.split("?")[1]||""),Z=s.get("isQuickPractice")==="true";console.log("ReframePractice parameters:",{userId:t,isQuickPractice:r||Z,propIsQuickPractice:r,urlIsQuickPractice:Z,hasPropPracticeScenarios:!!u,practiceScenarios:u,queryParamUserId:s.get("userId"),queryParamThoughtId:s.get("thoughtId")});const U=t!==void 0?String(t):g.userId||s.get("userId"),Q=U&&!isNaN(parseInt(U))?parseInt(U):a==null?void 0:a.id,_=h!==void 0?String(h):g.assignmentId||s.get("assignmentId"),v=_&&!isNaN(parseInt(_))?parseInt(_):void 0,W=c!==void 0?String(c):g.thoughtId||s.get("thoughtId"),l=W&&!isNaN(parseInt(W))?parseInt(W):void 0,[N,R]=w.useState(0),[ee,G]=w.useState(null),[F,se]=w.useState(!1),[B,ne]=w.useState([]),[ie,$]=w.useState(Date.now()),[J,T]=w.useState(!1),[f,I]=w.useState(0),[H,te]=w.useState(null),D=Q||(a==null?void 0:a.id),{data:we,isLoading:ue,error:Ce}=X({queryKey:v?[`/api/reframe-coach/assignments/${v}`]:[`/api/users/${D||0}/thoughts/${l||0}/practice-scenarios`],enabled:!u&&!!(v||D&&l),retry:3,staleTime:0}),re=we||{};let x=[];u?(x=u.scenarios||[],console.log("Using provided practice scenarios:",x)):v?x=((he=re.reframeData)==null?void 0:he.scenarios)||[]:x=re.scenarios||[];const ke=o=>{if(F)return;G(o),se(!0);const y=Date.now()-ie,p=Math.round(y/1e3/60),b=x[N].options[o].isCorrect,A=b?100:0,z=b?Math.max(0,50-Math.floor(y/1e3)):0,Te=A+z;I(ce=>ce+Te),ne(ce=>[...ce,{scenarioIndex:N,selectedOptionIndex:o,isCorrect:b,timeSpent:p}])},Ie=()=>{N<x.length-1?(R(o=>o+1),G(null),se(!1),$(Date.now())):T(!0)},oe=Ee({mutationFn:async o=>{console.log("Submitting practice results:",{thoughtRecordId:o.thoughtRecordId,userId:o.userId,assignmentId:o.assignmentId,score:o.score,totalQuestions:o.totalQuestions,correctAnswers:o.correctAnswers});const y=3;let p=0,C=null;for(;p<y;)try{const b={"Content-Type":"application/json"};a!=null&&a.id&&(console.log(`Attempt ${p+1}: Adding backup auth headers to results submission`,{userId:a.id}),b["x-auth-user-id"]=String(a.id),b["x-auth-fallback"]="true",b["x-auth-timestamp"]=String(Date.now()));try{localStorage.setItem("pendingPracticeResults",JSON.stringify({timestamp:Date.now(),userId:o.userId,score:o.score,correctAnswers:o.correctAnswers,totalQuestions:o.totalQuestions,thoughtRecordId:o.thoughtRecordId||null,assignmentId:o.assignmentId||null}))}catch(z){console.warn("Could not backup practice results to localStorage",z)}console.log(`Attempt ${p+1} of ${y} to save practice results...`);const A=await fetch("/api/reframe-coach/results",{method:"POST",headers:b,body:JSON.stringify(o)});if(!A.ok){const z=await A.text();throw console.error(`Attempt ${p+1}: Error saving results:`,{status:A.status,statusText:A.statusText,errorResponse:z}),new Error(`Failed to save results: ${A.status} ${A.statusText}`)}return localStorage.removeItem("pendingPracticeResults"),console.log("Results saved successfully on attempt",p+1),await A.json()}catch(b){C=b,p++,console.warn(`Failed to save results (attempt ${p} of ${y})`,b),p===1&&n({title:"Connection issue detected",description:"We'll try again to save your results...",variant:"destructive"}),p<y&&await new Promise(A=>setTimeout(A,1e3*Math.pow(2,p-1)))}throw console.error("All attempts to save results failed"),C||new Error("Failed to save practice results after multiple attempts")},onSuccess:o=>{console.log("Practice results saved successfully:",o),te(o.gameUpdates),D&&(m.invalidateQueries({queryKey:[`/api/users/${D}/reframe-coach/profile`]}),v&&m.invalidateQueries({queryKey:[`/api/users/${D}/reframe-coach/assignments`]})),n({title:"Practice Complete",description:"Your results have been saved successfully! Your progress is being tracked in your profile.",variant:"default",duration:5e3})},onError:o=>{console.error("Mutation error saving results:",o),n({title:"Error saving results",description:o.message||"Unknown error occurred",variant:"destructive"})}});Ne.useEffect(()=>{if(J&&!oe.isPending&&!H){const o=B.filter(C=>C.isCorrect).length;console.log("Preparing to save practice results:",{userChoices:B,thoughtRecordId:l,assignmentId:v,userChoicesCount:B.length,scenariosCount:x.length,correctAnswers:o});const y=B.map(C=>({scenarioIndex:C.scenarioIndex,selectedOptionIndex:C.selectedOptionIndex,isCorrect:C.isCorrect,timeSpent:C.timeSpent||0})),p={...v?{assignmentId:v}:{},thoughtRecordId:l||null,userId:D||null,score:f,correctAnswers:o,totalQuestions:x.length,streakCount:1,timeSpent:y.reduce((C,b)=>C+(b.timeSpent||0),0),scenarioData:x||[],userChoices:y||[]};console.log("Submitting practice results:",p),oe.mutate(p)}},[J,oe.isPending,H]);const Ae=()=>{console.log("Starting new practice - navigating back",{currentUserId:D,userId:a==null?void 0:a.id,isQuickPractice:r,thoughtRecordId:l});const o=D||(a==null?void 0:a.id)||0,y=r?`/users/${o}/thoughts`:`/users/${o}/reframe-coach`;console.log(`Navigating to: ${y}`),window.location.href=y};if(!u&&!ue&&(!D||!l&&!v))return e.jsxs(O,{variant:"destructive",className:"mb-6",children:[e.jsx(V,{className:"h-4 w-4"}),e.jsx(Y,{children:"Missing Information"}),e.jsx(K,{children:"Required parameters are missing. Please start from a thought record."}),e.jsx(L,{className:"mt-4",onClick:()=>i(`/users/${(a==null?void 0:a.id)||""}/thoughts`),children:"Go to Thoughts"})]});if(!u&&ue)return e.jsx("div",{className:"flex items-center justify-center p-12",children:e.jsxs("div",{className:"text-center",children:[e.jsx(ae,{className:"h-12 w-12 animate-spin text-primary mx-auto mb-4"}),e.jsx("p",{className:"text-muted-foreground",children:"Loading practice scenarios..."})]})});if(!u&&Ce)return e.jsxs(O,{variant:"destructive",className:"mb-6",children:[e.jsx(V,{className:"h-4 w-4"}),e.jsx(Y,{children:"Error"}),e.jsx(K,{children:"Failed to load practice scenarios. Please try again later."})]});if(!x||x.length===0)return e.jsxs(O,{variant:"destructive",className:"mb-6",children:[e.jsx(V,{className:"h-4 w-4"}),e.jsx(Y,{children:"No Scenarios Available"}),e.jsx(K,{children:r?"No practice scenarios were generated for this thought record. Please try again later.":"No practice scenarios available for this thought record."}),e.jsx(L,{className:"mt-4",onClick:()=>i(`/users/${D||(a==null?void 0:a.id)||""}/thoughts`),children:"Back to Thought Records"})]});if(J)return e.jsx(_e,{userChoices:B,scenarios:x,totalScore:f,userId:Q||0,gameUpdates:H,onStartNew:Ae,assignmentId:v,thoughtRecordId:l,isQuickPractice:r});const Pe=x.length||1,Se=(N+(F?.5:0))/Pe*100;return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"mb-4",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsx("h3",{className:"text-sm font-medium text-muted-foreground",children:"Progress"}),e.jsxs("span",{className:"text-sm text-muted-foreground",children:[N+1," of ",x.length]})]}),e.jsx(Re,{value:Se,className:"h-2"})]}),e.jsx(Ze,{scenario:x[N],currentIndex:N,totalScenarios:x.length,onSelectOption:ke,selectedOptionIndex:ee,showFeedback:F,onNext:Ie}),re.thoughtContent&&e.jsxs(P,{className:"mb-6",children:[e.jsx(q,{children:e.jsx(M,{className:"text-sm",children:"Original Thought"})}),e.jsx(S,{children:e.jsx("p",{className:"text-sm italic",children:re.thoughtContent})})]})]})},Je=({userId:t,thoughtId:c,className:h,limit:u=3})=>{de();const{data:r,isLoading:g}=X({queryKey:[`/api/users/${t}/reframe-coach/results`],enabled:!!t}),d=Ne.useMemo(()=>{if(!r||!Array.isArray(r))return[];let i=r;return c&&(i=r.filter(n=>n.thoughtRecordId===c)),i.sort((n,a)=>new Date(a.createdAt).getTime()-new Date(n.createdAt).getTime()).slice(0,u)},[r,c,u]);return g?e.jsx(P,{className:h,children:e.jsxs(S,{className:"py-6 text-center",children:[e.jsx(ae,{className:"h-6 w-6 animate-spin text-primary mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Loading practice history..."})]})}):d.length?e.jsxs(P,{className:h,children:[e.jsxs(q,{className:"pb-2",children:[e.jsx(M,{className:"text-lg",children:"Practice History"}),e.jsx(le,{children:"Your recent practice results"})]}),e.jsx(S,{className:"space-y-4",children:d.map(i=>e.jsx(P,{className:"border border-muted/60",children:e.jsxs(S,{className:"py-4 px-4",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(ye,{className:"mr-2 h-4 w-4 text-primary"}),e.jsx("span",{className:"text-sm font-medium",children:"Practice Session"})]}),e.jsxs("div",{className:"text-xs text-muted-foreground flex items-center",children:[e.jsx(Qe,{className:"mr-1 h-3 w-3"}),He(new Date(i.createdAt),"MMM d, yyyy")]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-2 my-3",children:[e.jsxs("div",{className:"text-center p-2 bg-muted/20 rounded-md",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Score"}),e.jsx("p",{className:"text-lg font-bold",children:i.score})]}),e.jsxs("div",{className:"text-center p-2 bg-muted/20 rounded-md",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Correct"}),e.jsxs("p",{className:"text-lg font-bold",children:[i.correctAnswers||i.correctCount||0," / ",i.totalQuestions||i.totalCount||0]})]}),e.jsxs("div",{className:"text-center p-2 bg-muted/20 rounded-md",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Accuracy"}),e.jsxs("p",{className:"text-lg font-bold",children:[Math.round((i.correctAnswers||i.correctCount||0)/(i.totalQuestions||i.totalCount||1)*100),"%"]})]})]}),e.jsx("div",{className:"mt-2",children:e.jsx("div",{className:"flex flex-wrap gap-1",children:i.scenarioData&&Array.isArray(i.scenarioData)?Array.from(new Set(i.scenarioData.map(n=>n.cognitiveDistortion).filter(Boolean))).map((n,a)=>e.jsxs(ge,{variant:"outline",className:"bg-primary/10 text-xs",children:[e.jsx(Fe,{className:"mr-1 h-3 w-3"}),String(n)]},a)):e.jsx(ge,{variant:"outline",className:"text-xs",children:"Cognitive Restructuring"})})}),i.streakCount>1&&e.jsxs("div",{className:"flex items-center text-xs text-primary-foreground mt-2 bg-primary/10 p-2 rounded",children:[e.jsx(Be,{className:"h-3 w-3 mr-1"}),e.jsxs("span",{children:["Streak: ",i.streakCount," correct answers in a row!"]})]})]})},i.id))})]}):e.jsx(P,{className:h,children:e.jsxs(S,{className:"py-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-1",children:"Practice History"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"No practice sessions found for this thought record. Complete a practice session to see your results here."})]})})};function fe(t){return t?t==="emotional-reasoning"?"Emotional Reasoning":t==="mind-reading"?"Mind Reading":t==="fortune-telling"?"Fortune Telling":t==="all-or-nothing"?"All or Nothing":t==="should-statements"?"Should Statements":t==="unknown"?"Cognitive Distortion":t.replace(/[-_]/g," ").split(" ").map(c=>c.charAt(0).toUpperCase()+c.slice(1)).join(" "):"Unknown"}const fs=()=>{const{user:t}=de(),c=je(),[h,u]=ve(),r=new URLSearchParams(h.split("?")[1]||""),g=c.userId||r.get("userId"),d=g&&!isNaN(parseInt(g))?parseInt(g):t==null?void 0:t.id,i=c.thoughtId||r.get("thoughtId"),n=i&&!isNaN(parseInt(i))?parseInt(i):void 0,a=c.assignmentId||r.get("assignmentId"),j=a&&!isNaN(parseInt(a))?parseInt(a):void 0,k=h.includes("/practice/quick/"),E=r.get("isQuickPractice"),m=k||E==="true";console.log("Quick Practice Detection:",{currentPath:h,hasQuickInPath:k,queryParam:E,finalIsQuickPractice:m});const{data:s,isLoading:Z,isError:be,error:U}=X({queryKey:[`/api/users/${d||0}/thoughts/${n||0}`],enabled:!!n&&!!d,queryFn:async({queryKey:T})=>{const f=T[0];console.log("Fetching thought record with URL:",f);try{const I={"Content-Type":"application/json"};t&&(console.log("Adding backup auth headers to thought record query",{userId:t.id}),I["x-auth-user-id"]=String(t.id),I["x-auth-fallback"]="true",I["x-auth-timestamp"]=String(Date.now()));const H=await fetch(f,{method:"GET",headers:I});if(!H.ok)throw new Error(`Failed to fetch thought record: ${H.status}`);const te=await H.json();return console.log("Thought record retrieved successfully:",te),te}catch(I){throw console.error("Error fetching thought record:",I),I}},retry:2,retryDelay:1e3}),{data:Q,isLoading:_,error:v,isError:W}=X({queryKey:[`/api/reframe-coach/assignments/${j||0}`],enabled:!!j&&!m,retry:1,retryDelay:1e3});console.log("Practice scenarios query params:",{isQuickPractice:m,isQuickPracticeParam:E,thoughtId:n,userId:d,enabled:m&&!!n&&!!d,isAuthenticated:!!t,queryString:h.split("?")[1]||""});const{data:l,isLoading:N,error:R,isError:ee}=X({queryKey:[`/api/users/${d||0}/thoughts/${n||0}/practice-scenarios?isQuickPractice=true`],enabled:m===!0&&!!n&&!!d&&!!t,retry:3,retryDelay:1e3,refetchOnWindowFocus:!1,refetchOnMount:!0}),G=(l==null?void 0:l.fromCache)===!0;w.useEffect(()=>{var T;if(l){const f=l;console.log(`Practice scenarios loaded successfully (${f.fromCache?"from cache":"new generation"})`,f)}R&&console.error("Failed to load practice scenarios:",R),s&&console.log("Thought record data:",{id:s==null?void 0:s.id,automaticThoughts:((T=s==null?void 0:s.automaticThoughts)==null?void 0:T.substring(0,30))+"...",cognitiveDistortions:s==null?void 0:s.cognitiveDistortions,rawType:s!=null&&s.cognitiveDistortions?typeof s.cognitiveDistortions:"undefined",isArray:Array.isArray(s==null?void 0:s.cognitiveDistortions)})},[l,R,s]);const F=(Z||_||N)&&!(W||ee),se=W&&!m||ee&&m,[B,ne]=w.useState(!1);w.useEffect(()=>{!n&&!j&&!F&&(ne(!0),setTimeout(()=>{u(`/users/${(t==null?void 0:t.id)||""}/thoughts`)},1500))},[n,j,F,t==null?void 0:t.id,u]);const ie={id:0,userId:d||0,automaticThoughts:"",cognitiveDistortions:["unknown"],alternativePerspective:"Consider a more balanced view of the situation",evidenceFor:"",evidenceAgainst:"",createdAt:new Date().toISOString()},$=s?{id:(s==null?void 0:s.id)||0,userId:(s==null?void 0:s.userId)||d||0,automaticThoughts:(s==null?void 0:s.automaticThoughts)||"",cognitiveDistortions:Array.isArray(s==null?void 0:s.cognitiveDistortions)?s==null?void 0:s.cognitiveDistortions:[],alternativePerspective:(s==null?void 0:s.alternativePerspective)||"Consider a more balanced view of the situation",evidenceFor:(s==null?void 0:s.evidenceFor)||"",evidenceAgainst:(s==null?void 0:s.evidenceAgainst)||"",createdAt:(s==null?void 0:s.createdAt)||new Date().toISOString()}:ie;console.log("ReframePracticePage params:",{userId:d,thoughtId:n,assignmentId:j,isQuickPractice:m,isQuickPracticeParam:E,pathUserId:c.userId,queryUserId:r.get("userId"),pathThoughtId:c.thoughtId,queryThoughtId:r.get("thoughtId"),pathAssignmentId:c.assignmentId,queryAssignmentId:r.get("assignmentId"),user:t==null?void 0:t.id,pathname:h.split("?")[0],fullLocation:h});const J=Q?"Reframe Practice Assignment":$.automaticThoughts&&$.automaticThoughts!=="No thought content available"?`Practice: ${$.automaticThoughts.slice(0,50)}${$.automaticThoughts.length>50?"...":""}`:"Cognitive Restructuring Practice";return e.jsx(Oe,{title:J,children:e.jsx("div",{className:"container max-w-4xl py-6",children:e.jsxs("div",{className:"mb-6",children:[e.jsxs(L,{variant:"outline",className:"mb-4",onClick:()=>window.history.back(),children:[e.jsx(Ye,{className:"mr-2 h-4 w-4"}),"Back"]}),n&&d&&!N&&!Z&&e.jsx("div",{className:"mb-6",children:e.jsx(Je,{userId:d,thoughtId:n})}),F||N?e.jsxs("div",{className:"flex flex-col justify-center items-center py-12",children:[e.jsx(ae,{className:"h-8 w-8 animate-spin text-primary mb-4"}),e.jsx("p",{className:"text-muted-foreground text-center font-medium",children:N?G?"Retrieving practice scenarios from cache...":"Generating practice scenarios based on your thought record. This may take up to 30 seconds...":"Loading..."}),N&&!G&&e.jsx("div",{className:"max-w-md mt-6 w-full bg-muted rounded-full h-3 dark:bg-gray-700 overflow-hidden",children:e.jsx("div",{className:"bg-primary h-3 rounded-full animate-progress"})}),N&&G&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"max-w-md mt-4 w-full bg-emerald-100 dark:bg-emerald-900/30 rounded-full h-3 overflow-hidden",children:e.jsx("div",{className:"bg-emerald-500 h-3 rounded-full animate-quick-progress"})}),e.jsxs("div",{className:"max-w-md mt-2 flex items-center gap-2 justify-center animate-pulse-slow",children:[e.jsx(me,{className:"h-5 w-5 text-emerald-500"}),e.jsx("span",{className:"text-sm text-emerald-600 dark:text-emerald-400 font-medium",children:"Using cached results for faster loading"})]})]})]}):B?e.jsxs(P,{className:"bg-amber-50 dark:bg-amber-950/30 border-amber-200 dark:border-amber-800 mb-6",children:[e.jsx(q,{children:e.jsxs(M,{className:"flex items-center gap-2",children:[e.jsx(V,{className:"h-5 w-5 text-amber-500"}),"Redirecting to Thought Records"]})}),e.jsxs(S,{children:[e.jsx("p",{className:"text-muted-foreground",children:"The Reframe Coach practice feature must be started from a thought record. You are being redirected to your thought records."}),e.jsx("div",{className:"flex justify-center my-4",children:e.jsx("div",{className:"h-2 w-full max-w-sm bg-amber-100 dark:bg-amber-900 rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-amber-500 animate-pulse rounded-full"})})})]})]}):se?e.jsxs(P,{className:"bg-red-50 dark:bg-red-950/30 border-red-200 dark:border-red-800 mb-6",children:[e.jsxs(q,{children:[e.jsxs(M,{className:"flex items-center gap-2",children:[e.jsx(V,{className:"h-5 w-5 text-red-500"}),m?"Failed to Load Practice Scenarios":"Practice Assignment Not Found"]}),e.jsxs(le,{className:"text-red-700 dark:text-red-400",children:["Error encountered at ",new Date().toLocaleTimeString()]})]}),e.jsx(S,{children:e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-muted-foreground",children:m?"We couldn't generate practice scenarios for this thought record. It may have insufficient content or no cognitive distortions identified. Try selecting a different thought record with clearer cognitive distortions.":`We couldn't find practice assignment #${j}. It may have been deleted or you may not have permission to access it.`}),e.jsxs("div",{className:"bg-red-100 dark:bg-red-900/30 p-3 rounded-md border border-red-200 dark:border-red-800",children:[e.jsx("p",{className:"text-sm font-medium text-red-800 dark:text-red-300",children:"Error Details:"}),e.jsx("pre",{className:"text-xs mt-1 bg-white/50 dark:bg-black/20 p-2 rounded overflow-auto max-h-24",children:m?(R==null?void 0:R.message)||"Failed to generate practice scenarios":(v==null?void 0:v.message)||"Assignment not found"})]}),e.jsxs("div",{className:"flex flex-col gap-3 sm:flex-row sm:justify-end",children:[e.jsxs(L,{variant:"outline",onClick:()=>window.location.reload(),className:"flex items-center",children:[e.jsx("svg",{className:"w-4 h-4 mr-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"})}),"Try Again"]}),e.jsxs(L,{variant:"default",onClick:()=>window.location.href=m?`/users/${d}/thoughts`:"/reframe-coach",children:["Return to ",m?"Thought Records":"Reframe Coach"]}),e.jsx(L,{variant:"ghost",onClick:()=>window.history.back(),children:"Go Back"})]})]})})]}):e.jsxs(e.Fragment,{children:[e.jsxs(P,{className:"mb-6",children:[e.jsxs(q,{children:[e.jsx(M,{children:"Cognitive Restructuring Practice"}),m&&e.jsxs(le,{children:["Working with your thought: ",e.jsx("span",{className:"font-medium",children:s&&s.automaticThoughts&&s.automaticThoughts!=="No thought content available"?`${s.automaticThoughts.substring(0,80)}${s.automaticThoughts.length>80?"...":""}`:l&&Array.isArray(l==null?void 0:l.scenarios)&&l.scenarios.length>0?"Practice scenarios based on cognitive distortions found in your thought record":"Please select a thought record"})]})]}),e.jsxs(S,{children:[e.jsx("p",{className:"text-muted-foreground",children:"This interactive exercise will help you practice identifying and challenging unhelpful thinking patterns. You'll be presented with scenarios and asked to select the most helpful reframing option."}),m&&l&&Array.isArray(l==null?void 0:l.scenarios)&&l.scenarios.length>0?e.jsxs("div",{className:"mt-3 p-3 rounded-md bg-amber-50 border border-amber-100",children:[e.jsx("h4",{className:"text-sm font-medium text-amber-800 mb-1",children:"Cognitive Distortions Identified:"}),e.jsx("div",{className:"flex flex-wrap gap-1",children:(()=>{const T=new Set;return l.scenarios.forEach(f=>{f.cognitiveDistortion&&T.add(fe(f.cognitiveDistortion))}),$.cognitiveDistortions&&$.cognitiveDistortions.length>0&&$.cognitiveDistortions.forEach(f=>{T.add(fe(f))}),Array.from(T).map((f,I)=>e.jsx("span",{className:"px-2 py-1 text-xs rounded-full bg-amber-100 text-amber-800",children:f},`distortion-${I}`))})()})]}):null,e.jsx("p",{className:"mt-2 text-muted-foreground",children:"Each correct answer earns points, and you can track your progress over time."})]})]}),m?l?e.jsx(xe,{userId:d,thoughtRecordId:n,isQuickPractice:!0,practiceScenarios:l}):e.jsxs("div",{className:"flex justify-center items-center py-12",children:[e.jsx(ae,{className:"h-8 w-8 animate-spin text-primary"}),e.jsx("span",{className:"ml-3 text-muted-foreground",children:"Generating relevant practice scenarios..."})]}):e.jsx(xe,{userId:d,thoughtRecordId:n,assignmentId:j,practiceScenarios:Q==null?void 0:Q.reframeData,isQuickPractice:m})]})]})})})};export{fs as default};
