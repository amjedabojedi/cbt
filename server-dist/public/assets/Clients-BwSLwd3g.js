import{u as de,n as me,y as ue,m as he,k as xe,r as C,j as e,B as a,C as L,e as A,f as E,g as k,a as R,x as je,h as w}from"./index-BJDVYPr2.js";import{u as M}from"./useQuery-CVl6tFXz.js";import{u as b}from"./useMutation-4_CoT2bx.js";import{B as P,f as ge,U as ve}from"./Header-HmO9KIvP.js";import{I as S}from"./input-C744jVRX.js";import{D as pe,f as fe,a as ye,b as Ne,c as Ce,d as we,e as be}from"./dialog-BkbRhY2O.js";import{u as Se,F as Ie,a as q,b as z,c as V,d as B,e as K,z as I,t as Te}from"./form-Bn3qej8w.js";import{A as Q}from"./AppLayout-B4pR-pjA.js";import{T as Fe,a as De,b as H,c as U}from"./tabs-DZkkmdmK.js";import{T as Le,a as Ae,b as O,c as v,d as Ee,e as p}from"./table-01yzukTO.js";import{U as T}from"./user-plus-CLHXHM-a.js";import{S as ke}from"./search-BLKRXzl6.js";import{U as $}from"./user-hKahD6_k.js";import{H as Re,T as Me,B as Pe,C as qe,M as ze}from"./target-7abParum.js";import{T as Ve}from"./trash-2-ZtlY59XR.js";import{C as Be}from"./clock-Od4KD6Fc.js";import{S as G}from"./send-D_NmVAMV.js";import"./utils-km2FGkQ4.js";import"./index-ZMpGrT0S.js";import"./index-epKMAjhH.js";import"./check-CPyQFfyd.js";import"./label-DKKVfa8V.js";const Ke=I.object({email:I.string().email("Please enter a valid email address"),name:I.string().min(2,"Name must be at least 2 characters")});function ms(){const{user:r}=de(),{toast:t}=me(),h=ue(),[,l]=he(),{setViewingClient:x}=xe(),[o,J]=C.useState(""),[_,g]=C.useState(!1),{data:c,isLoading:W}=M({queryKey:["/api/users/clients"],enabled:!!r&&(r.role==="therapist"||r.role==="admin")}),{data:f,isLoading:X}=M({queryKey:["/api/invitations"],enabled:!!r&&(r.role==="therapist"||r.role==="admin")}),j=Se({resolver:Te(Ke),defaultValues:{email:"",name:""}}),y=b({mutationFn:async s=>w("POST","/api/auth/invite-client",s),onSuccess:()=>{t({title:"Invitation sent!",description:"The client invitation has been sent successfully."}),g(!1),j.reset(),h.invalidateQueries({queryKey:["/api/users/clients"]}),h.invalidateQueries({queryKey:["/api/invitations"]})},onError:s=>{t({title:"Error",description:s.message||"Failed to send invitation.",variant:"destructive"})}}),Y=s=>{y.mutate(s)},Z=s=>{x(s.id,s.name||s.username),localStorage.setItem("viewingClientId",s.id.toString()),localStorage.setItem("viewingClientName",s.name||s.username),l("/emotions")},ee=s=>{x(s.id,s.name||s.username),localStorage.setItem("viewingClientId",s.id.toString()),localStorage.setItem("viewingClientName",s.name||s.username),l("/goals")},se=s=>{x(s.id,s.name||s.username),localStorage.setItem("viewingClientId",s.id.toString()),localStorage.setItem("viewingClientName",s.name||s.username),l("/journal")},ae=s=>{x(s.id,s.name||s.username),localStorage.setItem("viewingClientId",s.id.toString()),localStorage.setItem("viewingClientName",s.name||s.username),l("/thoughts")},ie=s=>{x(s.id,s.name||s.username),localStorage.setItem("viewingClientId",s.id.toString()),localStorage.setItem("viewingClientName",s.name||s.username),l("/dashboard")},te=s=>{l(`/client/${s.id}`)},ne=s=>{t({title:"Feature Coming Soon",description:"Direct messaging will be available in a future update."})},F=b({mutationFn:async s=>w("DELETE",`/api/users/clients/${s}`),onSuccess:()=>{t({title:"Client Removed",description:"The client has been successfully removed from your practice."}),h.invalidateQueries({queryKey:["/api/users/clients"]})},onError:s=>{t({title:"Error",description:s.message||"Failed to remove client",variant:"destructive"})}}),re=s=>{confirm(`Are you sure you want to remove ${s.name||s.username} from your practice? This action cannot be undone.`)&&F.mutate(s.id)},[D,N]=C.useState(null),le=b({mutationFn:async s=>(N(s),w("POST",`/api/invitations/${s}/resend`)),onSuccess:()=>{t({title:"Invitation Resent!",description:"The invitation has been sent again successfully."}),h.invalidateQueries({queryKey:["/api/invitations"]}),N(null)},onError:s=>{s.message.includes("Invitation not found")?(h.invalidateQueries({queryKey:["/api/invitations"]}),t({title:"Invitation Removed",description:"This invitation was already processed or removed."})):t({title:"Error",description:s.message||"Failed to resend invitation.",variant:"destructive"}),N(null)}}),oe=s=>{le.mutate(s)},d=c&&Array.isArray(c)?c.filter(s=>{var i,n,u;return((i=s.name)==null?void 0:i.toLowerCase().includes(o.toLowerCase()))||((n=s.username)==null?void 0:n.toLowerCase().includes(o.toLowerCase()))||((u=s.email)==null?void 0:u.toLowerCase().includes(o.toLowerCase()))}):[],m=(f&&Array.isArray(f)?f.filter(s=>s.status!=="pending"&&s.status!=="email_sent"?!1:!(c&&Array.isArray(c)?c.some(n=>n.email===s.email):!1)):[]).reduce((s,i)=>{const n=s.find(u=>u.email===i.email);if(!n)s.push(i);else if(i.id>n.id){const u=s.findIndex(ce=>ce.email===i.email);s[u]=i}return s},[]);return W?e.jsx(Q,{title:"Clients",children:e.jsx("div",{className:"container mx-auto px-4 py-6",children:e.jsx("div",{className:"text-center",children:"Loading clients..."})})}):e.jsx(Q,{title:"Clients",children:e.jsxs("div",{className:"container mx-auto px-4 py-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-neutral-800",children:"My Clients"}),e.jsx("p",{className:"text-neutral-500",children:"Manage your client relationships and progress"})]}),e.jsxs(pe,{open:_,onOpenChange:g,children:[e.jsx(fe,{asChild:!0,children:e.jsxs(a,{children:[e.jsx(T,{className:"mr-2 h-4 w-4"}),"Invite Client"]})}),e.jsxs(ye,{children:[e.jsxs(Ne,{children:[e.jsx(Ce,{children:"Invite New Client"}),e.jsx(we,{children:"Send an invitation to a new client to join your practice."})]}),e.jsx(Ie,{...j,children:e.jsxs("form",{onSubmit:j.handleSubmit(Y),className:"space-y-4",children:[e.jsx(q,{control:j.control,name:"email",render:({field:s})=>e.jsxs(z,{children:[e.jsx(V,{children:"Email Address"}),e.jsx(B,{children:e.jsx(S,{placeholder:"client@example.com",...s})}),e.jsx(K,{})]})}),e.jsx(q,{control:j.control,name:"name",render:({field:s})=>e.jsxs(z,{children:[e.jsx(V,{children:"Full Name"}),e.jsx(B,{children:e.jsx(S,{placeholder:"John Doe",...s})}),e.jsx(K,{})]})}),e.jsx(be,{children:e.jsx(a,{type:"submit",disabled:y.isPending,children:y.isPending?"Sending...":"Send Invitation"})})]})})]})]})]}),e.jsx("div",{className:"mb-6",children:e.jsxs("div",{className:"relative",children:[e.jsx(ke,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 h-4 w-4"}),e.jsx(S,{placeholder:"Search clients by name, username, or email...",value:o,onChange:s=>J(s.target.value),className:"pl-10"})]})}),e.jsxs(Fe,{defaultValue:"clients",className:"w-full",children:[e.jsxs(De,{className:"grid w-full grid-cols-2",children:[e.jsx(H,{value:"clients",children:"Active Clients"}),e.jsxs(H,{value:"invitations",children:["Pending Invitations",m&&m.length>0&&e.jsx(P,{variant:"secondary",className:"ml-2",children:m.length})]})]}),e.jsxs(U,{value:"clients",className:"space-y-6",children:[e.jsx("div",{className:"grid gap-6 md:grid-cols-2 lg:grid-cols-2",children:d==null?void 0:d.map(s=>e.jsxs(L,{className:"hover:shadow-lg transition-shadow",children:[e.jsx(A,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center",children:e.jsx($,{className:"h-5 w-5 text-blue-600"})}),e.jsxs("div",{children:[e.jsx(E,{className:"text-lg",children:s.name||s.username}),e.jsx(k,{className:"text-sm",children:s.email})]})]}),e.jsx(P,{variant:s.status==="active"?"default":"secondary",children:s.status})]})}),e.jsxs(R,{children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4 mb-4",children:[e.jsxs(a,{variant:"outline",size:"sm",className:"flex items-center justify-center",onClick:()=>Z(s),children:[e.jsx(Re,{className:"mr-1 h-4 w-4"}),"Records"]}),e.jsxs(a,{variant:"outline",size:"sm",className:"flex items-center justify-center",onClick:()=>ee(s),children:[e.jsx(Me,{className:"mr-1 h-4 w-4"}),"Goals"]}),e.jsxs(a,{variant:"outline",size:"sm",className:"flex items-center justify-center",onClick:()=>se(s),children:[e.jsx(ge,{className:"mr-1 h-4 w-4"}),"Journal"]}),e.jsxs(a,{variant:"outline",size:"sm",className:"flex items-center justify-center",onClick:()=>ae(s),children:[e.jsx(Pe,{className:"mr-1 h-4 w-4"}),"Thoughts"]})]}),e.jsxs("div",{className:"flex gap-2 mb-2",children:[e.jsxs(a,{variant:"default",size:"sm",className:"flex-1",onClick:()=>te(s),children:[e.jsx($,{className:"mr-1 h-4 w-4"}),"View Profile"]}),e.jsxs(a,{variant:"outline",size:"sm",className:"flex-1",onClick:()=>ie(s),children:[e.jsx(qe,{className:"mr-1 h-4 w-4"}),"Dashboard"]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(a,{variant:"outline",size:"sm",onClick:()=>ne(),children:e.jsx(ze,{className:"h-4 w-4"})}),e.jsx(a,{variant:"destructive",size:"sm",onClick:()=>re(s),disabled:F.isPending,children:e.jsx(Ve,{className:"h-4 w-4"})})]})]})]},s.id))}),(d==null?void 0:d.length)===0&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx(ve,{className:"mx-auto h-12 w-12 text-gray-400 mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"No clients found"}),e.jsx("p",{className:"text-gray-500 mb-4",children:o?"No clients match your search.":"Get started by inviting your first client."}),!o&&e.jsxs(a,{onClick:()=>g(!0),children:[e.jsx(T,{className:"mr-2 h-4 w-4"}),"Invite First Client"]})]})]}),e.jsx(U,{value:"invitations",className:"space-y-6",children:e.jsxs(L,{children:[e.jsxs(A,{children:[e.jsxs(E,{className:"flex items-center gap-2",children:[e.jsx(Be,{className:"h-5 w-5"}),"Pending Invitations"]}),e.jsx(k,{children:"Manage client invitations that haven't been accepted yet"})]}),e.jsx(R,{children:X?e.jsx("div",{className:"text-center py-8",children:"Loading invitations..."}):m&&m.length>0?e.jsxs(Le,{children:[e.jsx(Ae,{children:e.jsxs(O,{children:[e.jsx(v,{children:"Email"}),e.jsx(v,{children:"Name"}),e.jsx(v,{children:"Latest Invitation"}),e.jsx(v,{className:"text-right",children:"Actions"})]})}),e.jsx(Ee,{children:m.map(s=>e.jsxs(O,{children:[e.jsx(p,{className:"font-medium",children:s.email}),e.jsx(p,{children:s.name}),e.jsx(p,{children:s.createdAt?new Date(s.createdAt).toLocaleDateString():"N/A"}),e.jsx(p,{className:"text-right",children:e.jsxs(a,{variant:"outline",size:"sm",onClick:()=>oe(s.id),disabled:D===s.id,children:[D===s.id?e.jsx(je,{className:"h-4 w-4 animate-spin"}):e.jsx(G,{className:"h-4 w-4"}),e.jsx("span",{className:"ml-2",children:"Resend"})]})})]},s.id))})]}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx(G,{className:"mx-auto h-12 w-12 text-gray-400 mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"No pending invitations"}),e.jsx("p",{className:"text-gray-500 mb-4",children:"All your invitations have been accepted or you haven't sent any yet."}),e.jsxs(a,{onClick:()=>g(!0),children:[e.jsx(T,{className:"mr-2 h-4 w-4"}),"Send New Invitation"]})]})})]})})]})]})})}export{ms as default};
