import{c as de,m as me,u as ue,n as he,r as o,j as e,B as i,C as z,a as O,i as j,b as xe,h as m}from"./index-BJDVYPr2.js";import{L as je}from"./Layout-MHH3-5YO.js";import{T as pe,f as ge,a as fe,b as H,c as v,d as ve,e as p}from"./table-01yzukTO.js";import{T as we,a as be,b as U}from"./tabs-DZkkmdmK.js";import{D as V,a as B,b as q,c as K,d as G,e as _}from"./dialog-BkbRhY2O.js";import{B as Ne,A as Ce,U as ye}from"./Header-HmO9KIvP.js";import{I as d}from"./input-C744jVRX.js";import{S as Se,a as Pe,b as Ae,c as ke,d as Ue}from"./select-Bh-crIyN.js";import{u as Fe}from"./useQuery-CVl6tFXz.js";import{u as C}from"./useMutation-4_CoT2bx.js";import{A as De,a as Ee,b as Le,c as Te,d as Ie,e as Re,f as Me,g as $e}from"./alert-dialog-bBvWK-5Q.js";import{L as u}from"./label-DKKVfa8V.js";import{U as ze}from"./user-plus-CLHXHM-a.js";import{P as Oe}from"./plus-CIrJHrh4.js";import{S as He}from"./square-pen-BwPwTV1q.js";import{T as Ve}from"./trash-2-ZtlY59XR.js";import{U as Be}from"./user-check-CnUqHDMm.js";import"./target-7abParum.js";import"./index-epKMAjhH.js";import"./index-ZMpGrT0S.js";import"./check-CPyQFfyd.js";import"./index-pLghM4Oe.js";import"./chevron-down-JR_7gpC-.js";import"./utils-km2FGkQ4.js";/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const qe=de("Key",[["path",{d:"m15.5 7.5 2.3 2.3a1 1 0 0 0 1.4 0l2.1-2.1a1 1 0 0 0 0-1.4L19 4",key:"g0fldk"}],["path",{d:"m21 2-9.6 9.6",key:"1j0ho8"}],["circle",{cx:"7.5",cy:"15.5",r:"5.5",key:"yqb3hr"}]]);function ps(){var ee,se;const[Ke,Q]=me(),{user:F}=ue(),{toast:n}=he(),[w,W]=o.useState([]),[D,Y]=o.useState(!0),[y,ae]=o.useState(""),[E,re]=o.useState("therapist"),[a,S]=o.useState(null),[L,te]=o.useState(null),[l,h]=o.useState(null),[g,P]=o.useState(null),[ie,A]=o.useState(!1),[ne,b]=o.useState(!1),[k,J]=o.useState("therapist"),[c,f]=o.useState({name:"",email:"",username:"",password:""}),{data:X=[],isLoading:le}=Fe({queryKey:["/api/subscription-plans"],queryFn:async()=>{const s=await m("GET","/api/subscription-plans");if(!s.ok)throw new Error("Failed to fetch subscription plans");return s.json()}}),T=C({mutationFn:async s=>{const{id:r,...t}=s,N=await m("PATCH",`/api/users/${r}`,t);if(!N.ok){const ce=await N.json();throw new Error(ce.message||"Failed to update user")}return N.json()},onSuccess:s=>{n({title:"User Updated",description:"User information has been updated successfully."}),W(r=>r.map(t=>t.id===s.id?s:t)),h(null),A(!1)},onError:s=>{n({title:"Update Failed",description:s.message,variant:"destructive"})}}),I=C({mutationFn:async s=>{const r=await m("POST",`/api/users/${s}/reset-password`);if(!r.ok){const t=await r.json();throw new Error(t.message||"Failed to reset password")}return r.json()},onSuccess:s=>{n({title:"Password Reset",description:`Password has been reset to "${s.defaultPassword}". Please share this with the user.`}),A(!1)},onError:s=>{n({title:"Password Reset Failed",description:s.message,variant:"destructive"})}}),Z=C({mutationFn:async s=>{const r=await m("DELETE",`/api/users/${s}`);if(!r.ok){const t=await r.json();throw new Error(t.message||"Failed to delete user")}return s},onSuccess:s=>{n({title:"User Deleted",description:"User has been deleted successfully."}),P(null),x()},onError:s=>{n({title:"Deletion Failed",description:s.message,variant:"destructive"})}}),R=C({mutationFn:async({userId:s,planId:r})=>{const t=await m("POST",`/api/users/${s}/subscription-plan`,{planId:r});if(!t.ok){const N=await t.json();throw new Error(N.message||"Failed to assign subscription plan")}return t.json()},onSuccess:s=>{n({title:"Plan Assigned",description:"Subscription plan has been assigned to the therapist successfully."}),a&&a.id===s.id&&S(s),x()},onError:s=>{n({title:"Assignment Failed",description:s.message,variant:"destructive"})}}),M=C({mutationFn:async s=>{const r=await m("POST","/api/users/register-by-admin",s);if(!r.ok){const t=await r.json();throw new Error(t.message||"Failed to create user")}return r.json()},onSuccess:()=>{n({title:"User Created",description:`The ${k} has been created successfully.`}),f({name:"",email:"",username:"",password:""}),b(!1),x()},onError:s=>{n({title:"User Creation Failed",description:s.message,variant:"destructive"})}}),x=async()=>{try{Y(!0);const s=new Date().getTime(),t=await(await m("GET",`/api/users?_t=${s}`)).json();W(t),console.log("Fetched users:",t)}catch(s){console.error("Error fetching users:",s),n({title:"Error",description:"Failed to load user data",variant:"destructive"})}finally{Y(!1)}};o.useEffect(()=>{if(F&&F.role!=="admin"){n({title:"Access Denied",description:"You do not have permission to access this page.",variant:"destructive"}),Q("/");return}x();const s=setInterval(()=>{x()},6e4);return()=>clearInterval(s)},[F,Q,n]);const $=w.filter(s=>{const r=s.name.toLowerCase().includes(y.toLowerCase())||s.username.toLowerCase().includes(y.toLowerCase())||s.email.toLowerCase().includes(y.toLowerCase());return E==="all"?r:r&&s.role===E}),oe=s=>{switch(s){case"admin":return"bg-purple-50 text-purple-700 border-purple-200";case"therapist":return"bg-green-50 text-green-700 border-green-200";case"client":return"bg-blue-50 text-blue-700 border-blue-200";default:return"bg-gray-50 text-gray-700 border-gray-200"}};return e.jsxs(je,{title:"Therapist Management",children:[e.jsxs("div",{className:"container mx-auto px-4 py-6",children:[e.jsxs("div",{className:"flex flex-col md:flex-row justify-between items-start md:items-center mb-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Therapist Management"}),e.jsx("p",{className:"text-muted-foreground",children:"Manage therapists and their client assignments"})]}),e.jsxs("div",{className:"mt-4 md:mt-0 flex flex-col sm:flex-row gap-2",children:[e.jsxs(i,{className:"flex items-center",onClick:()=>{J("therapist"),b(!0)},children:[e.jsx(ze,{className:"mr-2 h-4 w-4"}),"Add Therapist"]}),e.jsxs(i,{onClick:()=>{J("admin"),b(!0)},children:[e.jsx(Oe,{className:"mr-2 h-4 w-4"}),"Add Admin"]})]})]}),e.jsx(z,{className:"mb-6",children:e.jsx(O,{className:"p-6",children:e.jsxs("div",{className:"flex flex-col md:flex-row gap-4 items-start md:items-center justify-between",children:[e.jsxs("div",{className:"flex gap-2 w-full md:w-auto",children:[e.jsx(d,{placeholder:"Search users...",value:y,onChange:s=>ae(s.target.value),className:"w-full md:w-64"}),e.jsx(i,{variant:"outline",size:"icon",onClick:x,disabled:D,title:"Refresh user data",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:`h-4 w-4 ${D?"animate-spin":""}`,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"})})})]}),e.jsx(we,{defaultValue:"therapist",value:E,onValueChange:re,className:"w-full md:w-auto",children:e.jsxs(be,{className:"grid grid-cols-4 w-full md:w-auto",children:[e.jsx(U,{value:"all",children:"All"}),e.jsx(U,{value:"client",children:"Clients"}),e.jsx(U,{value:"therapist",children:"Therapists"}),e.jsx(U,{value:"admin",children:"Admins"})]})})]})})}),e.jsx(z,{children:e.jsx(O,{className:"p-0 overflow-auto",children:D?e.jsx("div",{className:"flex justify-center items-center py-20",children:e.jsx(j,{className:"h-8 w-8 animate-spin text-primary"})}):e.jsxs(pe,{children:[e.jsxs(ge,{children:["Showing ",$.length," of ",w.length," users"]}),e.jsx(fe,{children:e.jsxs(H,{children:[e.jsx(v,{children:"Name"}),e.jsx(v,{children:"Username"}),e.jsx(v,{children:"Email"}),e.jsx(v,{children:"Role"}),e.jsx(v,{children:"Created"}),e.jsx(v,{children:"Actions"})]})}),e.jsx(ve,{children:$.length===0?e.jsx(H,{children:e.jsx(p,{colSpan:6,className:"text-center py-10 text-muted-foreground",children:"No users found"})}):$.map(s=>e.jsxs(H,{children:[e.jsx(p,{className:"font-medium",children:s.name}),e.jsx(p,{children:s.username}),e.jsx(p,{children:s.email}),e.jsx(p,{children:e.jsx(Ne,{variant:"outline",className:oe(s.role),children:s.role})}),e.jsx(p,{children:new Date(s.createdAt).toLocaleDateString()}),e.jsx(p,{children:e.jsxs("div",{className:"flex items-center space-x-2",children:[s.role==="therapist"&&e.jsx(i,{variant:"outline",size:"sm",className:"mr-2",onClick:()=>S(s),children:"Manage Clients"}),e.jsx(i,{variant:"ghost",size:"icon",onClick:()=>h(s),children:e.jsx(He,{className:"h-4 w-4"})}),e.jsx(i,{variant:"ghost",size:"icon",onClick:()=>P(s),children:e.jsx(Ve,{className:"h-4 w-4 text-destructive"})})]})})]},s.id))})]})})})]}),e.jsx(V,{open:!!a,onOpenChange:s=>!s&&S(null),children:e.jsxs(B,{className:"max-w-3xl",children:[e.jsxs(q,{children:[e.jsxs(K,{children:["Manage Clients for ",a==null?void 0:a.name]}),e.jsx(G,{children:"Assign or remove clients from this therapist"})]}),e.jsxs("div",{className:"mb-6 border rounded-md p-4",children:[e.jsxs("h3",{className:"text-sm font-medium mb-3 flex items-center",children:[e.jsx(Ce,{className:"h-4 w-4 mr-1"}),"Subscription Plan"]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("p",{className:"text-sm text-muted-foreground mb-2",children:["Current Plan:",a!=null&&a.subscriptionPlanId?e.jsx("span",{className:"font-medium text-foreground ml-1",children:((ee=X.find(s=>s.id===a.subscriptionPlanId))==null?void 0:ee.name)||"Unknown plan"}):e.jsx("span",{className:"italic text-muted-foreground ml-1",children:"No plan assigned"})]}),e.jsxs("p",{className:"text-sm text-muted-foreground mb-4",children:["Status:",e.jsx("span",{className:xe("ml-1 px-2 py-0.5 rounded-full text-xs font-medium",(a==null?void 0:a.subscriptionStatus)==="active"?"bg-green-100 text-green-700":(a==null?void 0:a.subscriptionStatus)==="trial"?"bg-blue-100 text-blue-700":(a==null?void 0:a.subscriptionStatus)==="canceled"?"bg-amber-100 text-amber-700":(a==null?void 0:a.subscriptionStatus)==="past_due"?"bg-red-100 text-red-700":"bg-gray-100 text-gray-700"),children:(a==null?void 0:a.subscriptionStatus)||"None"})]})]}),e.jsxs("div",{children:[e.jsxs(Se,{onValueChange:s=>te(Number(s)),defaultValue:((se=a==null?void 0:a.subscriptionPlanId)==null?void 0:se.toString())||"",children:[e.jsx(Pe,{className:"w-full",children:e.jsx(Ae,{placeholder:"Select a plan"})}),e.jsx(ke,{children:le?e.jsxs("div",{className:"flex items-center justify-center p-2",children:[e.jsx(j,{className:"h-4 w-4 animate-spin mr-2"}),e.jsx("span",{children:"Loading plans..."})]}):X.filter(s=>s.isActive).map(s=>e.jsxs(Ue,{value:s.id.toString(),children:[s.name," ($",s.price,"/",s.interval,", ",s.maxClients," clients)"]},s.id))})]}),e.jsx("div",{className:"mt-3",children:e.jsxs(i,{size:"sm",onClick:()=>{!L||!a||R.mutate({userId:a.id,planId:L})},disabled:!L||R.isPending,className:"w-full",children:[R.isPending&&e.jsx(j,{className:"h-4 w-4 mr-2 animate-spin"}),"Assign Plan"]})})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6 py-6",children:[e.jsxs("div",{children:[e.jsxs("h3",{className:"text-sm font-medium mb-3 flex items-center",children:[e.jsx(ye,{className:"h-4 w-4 mr-1"}),"Available Clients"]}),e.jsxs("div",{className:"border rounded-md overflow-hidden",children:[e.jsx("div",{className:"p-3 bg-secondary/30",children:e.jsx(d,{placeholder:"Search clients...",className:"text-sm"})}),e.jsx("div",{className:"max-h-72 overflow-y-auto",children:w.filter(s=>s.role==="client"&&(!s.therapistId||s.therapistId!==(a==null?void 0:a.id))).map(s=>e.jsxs("div",{className:"p-3 border-b last:border-0 flex justify-between items-center hover:bg-secondary/20",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-primary/20 flex items-center justify-center text-primary mr-2",children:s.name.charAt(0)}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:s.name}),e.jsx("div",{className:"text-xs text-muted-foreground",children:s.email})]})]}),e.jsx(i,{size:"sm",variant:"ghost",onClick:()=>{n({title:"Client Assigned",description:`${s.name} has been assigned to ${a==null?void 0:a.name}`})},children:"Assign"})]},s.id))})]})]}),e.jsxs("div",{children:[e.jsxs("h3",{className:"text-sm font-medium mb-3 flex items-center",children:[e.jsx(Be,{className:"h-4 w-4 mr-1"}),"Assigned Clients"]}),e.jsx("div",{className:"border rounded-md overflow-hidden",children:e.jsxs("div",{className:"max-h-[19.5rem] overflow-y-auto",children:[w.filter(s=>s.role==="client"&&s.therapistId===(a==null?void 0:a.id)).map(s=>e.jsxs("div",{className:"p-3 border-b last:border-0 flex justify-between items-center hover:bg-secondary/20",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-primary/20 flex items-center justify-center text-primary mr-2",children:s.name.charAt(0)}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:s.name}),e.jsx("div",{className:"text-xs text-muted-foreground",children:s.email})]})]}),e.jsx(i,{size:"sm",variant:"ghost",className:"text-destructive hover:text-destructive hover:bg-destructive/10",onClick:async()=>{try{const r=await m("PATCH",`/api/users/${s.id}/unassign-therapist`);if(!r.ok){const t=await r.json();throw new Error(t.message||"Failed to remove client")}n({title:"Client Removed",description:`${s.name} has been removed from ${a==null?void 0:a.name}`}),x()}catch(r){console.error("Error removing client:",r),n({title:"Error",description:r instanceof Error?r.message:"Failed to remove client",variant:"destructive"})}},children:"Remove"})]},s.id)),w.filter(s=>s.role==="client"&&s.therapistId===(a==null?void 0:a.id)).length===0&&e.jsx("div",{className:"p-8 text-center text-muted-foreground text-sm",children:"No clients assigned to this therapist"})]})})]})]}),e.jsx(_,{children:e.jsx(i,{variant:"outline",onClick:()=>S(null),children:"Close"})})]})}),e.jsx(V,{open:!!l,onOpenChange:s=>!s&&h(null),children:e.jsxs(B,{className:"max-w-md",children:[e.jsxs(q,{children:[e.jsx(K,{children:"Edit User"}),e.jsx(G,{children:"Update user information"})]}),l&&e.jsx("div",{className:"space-y-4 py-4",children:e.jsxs("div",{className:"grid gap-4",children:[e.jsxs("div",{className:"grid gap-2",children:[e.jsx(u,{htmlFor:"name",children:"Name"}),e.jsx(d,{id:"name",defaultValue:l.name,onChange:s=>{h({...l,name:s.target.value})}})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(u,{htmlFor:"email",children:"Email"}),e.jsx(d,{id:"email",type:"email",defaultValue:l.email,onChange:s=>{h({...l,email:s.target.value})}})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(u,{htmlFor:"username",children:"Username"}),e.jsx(d,{id:"username",defaultValue:l.username,onChange:s=>{h({...l,username:s.target.value})}})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(u,{children:"Password Management"}),e.jsxs(i,{type:"button",variant:"outline",className:"w-full flex items-center justify-center",onClick:()=>A(!0),children:[e.jsx(qe,{className:"mr-2 h-4 w-4"}),"Reset Password to Default"]}),ie&&e.jsx(z,{className:"p-4 border border-amber-200 bg-amber-50",children:e.jsxs(O,{className:"p-0",children:[e.jsx("p",{className:"text-sm text-amber-700 mb-2",children:"This will reset the user's password to a default value (123456). The user will need to change it on their next login."}),e.jsxs("div",{className:"flex justify-end gap-2 mt-2",children:[e.jsx(i,{variant:"outline",size:"sm",onClick:()=>A(!1),children:"Cancel"}),e.jsxs(i,{variant:"default",size:"sm",onClick:()=>{l&&I.mutate(l.id)},disabled:I.isPending,children:[I.isPending&&e.jsx(j,{className:"h-3 w-3 mr-2 animate-spin"}),"Confirm Reset"]})]})]})})]})]})}),e.jsxs(_,{children:[e.jsx(i,{variant:"outline",onClick:()=>h(null),children:"Cancel"}),e.jsxs(i,{onClick:()=>{l&&T.mutate({id:l.id,name:l.name,username:l.username,email:l.email})},disabled:T.isPending,children:[T.isPending&&e.jsx(j,{className:"h-4 w-4 mr-2 animate-spin"}),"Save Changes"]})]})]})}),e.jsx(De,{open:!!g,onOpenChange:s=>!s&&P(null),children:e.jsxs(Ee,{children:[e.jsxs(Le,{children:[e.jsx(Te,{children:"Are you sure?"}),e.jsxs(Ie,{children:["This will permanently delete ",g==null?void 0:g.name,"'s account and all associated data. This action cannot be undone."]})]}),e.jsxs(Re,{children:[e.jsx(Me,{onClick:()=>P(null),children:"Cancel"}),e.jsxs($e,{onClick:()=>{g&&Z.mutate(g.id)},className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:[Z.isPending&&e.jsx(j,{className:"h-4 w-4 mr-2 animate-spin"}),"Delete"]})]})]})}),e.jsx(V,{open:ne,onOpenChange:s=>{b(s),s||f({name:"",email:"",username:"",password:""})},children:e.jsxs(B,{className:"max-w-md",children:[e.jsxs(q,{children:[e.jsx(K,{children:k==="therapist"?"Add New Therapist":"Add New Admin"}),e.jsxs(G,{children:["Create a new ",k," account."]})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(u,{htmlFor:"name",className:"text-right",children:"Name"}),e.jsx(d,{id:"name",className:"col-span-3",placeholder:"Full name",value:c.name,onChange:s=>f(r=>({...r,name:s.target.value}))})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(u,{htmlFor:"email",className:"text-right",children:"Email"}),e.jsx(d,{id:"email",className:"col-span-3",type:"email",placeholder:"Email address",value:c.email,onChange:s=>f(r=>({...r,email:s.target.value}))})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(u,{htmlFor:"username",className:"text-right",children:"Username"}),e.jsx(d,{id:"username",className:"col-span-3",placeholder:"Username for login",value:c.username,onChange:s=>f(r=>({...r,username:s.target.value}))})]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(u,{htmlFor:"password",className:"text-right",children:"Password"}),e.jsx(d,{id:"password",type:"password",className:"col-span-3",placeholder:"Temporary password",value:c.password,onChange:s=>f(r=>({...r,password:s.target.value}))})]})]}),e.jsxs(_,{children:[e.jsx(i,{type:"button",variant:"outline",onClick:()=>b(!1),children:"Cancel"}),e.jsx(i,{onClick:()=>{M.mutate({...c,role:k})},disabled:M.isPending||!c.name||!c.email||!c.username||!c.password,children:M.isPending?e.jsxs(e.Fragment,{children:[e.jsx(j,{className:"h-4 w-4 mr-2 animate-spin"}),"Creating..."]}):"Create User"})]})]})})]})}export{ps as default};
