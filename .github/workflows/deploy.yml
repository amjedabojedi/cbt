name: CBT Auto Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18.19.1
      - name: Install Dependencies
        run: npm install --legacy-peer-deps
      - name: Build Project
        run: npm run build

  deploy-production:
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: '${{ secrets.SSH_KEY }}'
      - name: Deploy to Server
        run: >
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            cd /var/www/cbt-client/cbt
            echo "Pulling latest code..."
            git pull origin main
            echo "Installing dependencies..."
            npm install --legacy-peer-deps
            echo "Building project..."
            npm run build
            echo "Restarting backend..."
            pm2 restart cbt-backend || pm2 start server-dist/index.js --name "cbt-backend" --env production
            echo "Reloading Nginx..."
            sudo systemctl reload nginx
            echo "Deployment complete!"
          EOF

  notify-on-failure:
    runs-on: ubuntu-latest
    needs: [build, deploy-production]
    if: failure()  # âœ… Only runs if any of the above jobs fail
    steps:
      - name: Send Failure Email via SparkPost
        run: |
          echo "Sending email notification..."
          curl -X POST "https://api.sparkpost.com/api/v1/transmissions" \
            -H "Authorization: ${{ secrets.SPARKPOST_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{
              "options": { "sandbox": false },
              "content": {
                "from": { "email": "'"${{ secrets.SPARKPOST_SENDER }}"'" },
                "subject": "ðŸš¨ GitHub Action Failed: '"${{ github.workflow }}"'",
                "text": "The workflow *'"${{ github.workflow }}"'* failed on branch *'"${{ github.ref }}"'*.\\n\\nCheck details: '"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"'"
              },
              "recipients": [{ "address": "'"${{ secrets.ALERT_EMAIL }}"'" }]
            }'


# name: Auto Deploy to Production
# 'on':
#   push:
#     branches:
#       - main
# jobs:
#   build:
#     runs-on: ubuntu-latest
#     steps:
#       - name: Checkout Repository
#         uses: actions/checkout@v4
#       - name: Set up Node.js
#         uses: actions/setup-node@v3
#         with:
#           node-version: 18.19.1
#       - name: Install Dependencies
#         run: npm install --legacy-peer-deps
#       - name: Build Project
#         run: npm run build
#   deploy-production:
#     runs-on: ubuntu-latest
#     needs: build
#     if: github.ref == 'refs/heads/main'
#     steps:
#       - name: Checkout Repository
#         uses: actions/checkout@v4
#       - name: Setup SSH
#         uses: webfactory/ssh-agent@v0.7.0
#         with:
#           ssh-private-key: '${{ secrets.SSH_KEY }}'
#       - name: Deploy to Server
#         run: >
#           ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{
#           secrets.SSH_HOST }} << 'EOF'
#             cd /var/www/cbt-client/cbt
#             echo "Pulling latest code..."
#             git pull origin main
#             echo "Installing dependencies..."
#             npm install --legacy-peer-deps
#             echo "Building project..."
#             npm run build
#             echo "Restarting backend..."
#             pm2 restart cbt-backend || pm2 start server-dist/index.js --name "cbt-backend" --env production
#             echo "Reloading Nginx..."
#             sudo systemctl reload nginx
#             echo "Deployment complete!"
#           EOF
